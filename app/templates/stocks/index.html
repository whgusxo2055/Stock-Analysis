{% extends "base.html" %}

{% block title %}관심 종목 관리 - Stock Analysis{% endblock %}

{% block extra_css %}
<style>
/* 검색 자동완성 스타일 */
.stock-search-container {
    position: relative;
}

.search-dropdown {
    position: absolute;
    width: 100%;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
}

.search-dropdown.show {
    display: block;
}

.search-item {
    padding: 12px 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.15s;
}

.search-item:last-child {
    border-bottom: none;
}

.search-item:hover, .search-item.selected {
    background-color: #f8f9fa;
}

.search-item.is-watchlist {
    background-color: #e8f5e9;
}

.search-item.is-watchlist:hover {
    background-color: #c8e6c9;
}

.search-item-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.search-item .ticker {
    font-weight: 700;
    color: #1976D2;
    font-size: 1.1em;
}

.search-item .name {
    color: #555;
    font-size: 0.9em;
}

.search-item-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.search-item .sector {
    font-size: 0.75em;
    color: #888;
    background: #f0f0f0;
    padding: 2px 8px;
    border-radius: 10px;
}

.search-item .watchlist-badge {
    color: #4CAF50;
    font-size: 0.85em;
}

.search-item .add-badge {
    color: #1976D2;
    font-size: 0.85em;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #888;
}

.search-loading {
    padding: 20px;
    text-align: center;
    color: #888;
}

#stockSearchInput {
    border-radius: 8px;
    padding: 12px 15px;
    font-size: 1em;
    border: 2px solid #e0e0e0;
    transition: border-color 0.2s;
}

#stockSearchInput:focus {
    border-color: #1976D2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
}

.search-hint {
    font-size: 0.85em;
    color: #888;
    margin-top: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-star-fill text-warning"></i> 관심 종목 관리
            </h2>
        </div>
    </div>
    
    <!-- 종목 추가 폼 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-search"></i> 종목 검색 및 추가</h5>
                </div>
                <div class="card-body">
                    <div class="stock-search-container">
                        <input type="text" 
                               id="stockSearchInput" 
                               class="form-control" 
                               placeholder="티커 또는 회사명 검색 (예: AAPL, Apple, 테슬라)"
                               autocomplete="off">
                        <div id="searchResults" class="search-dropdown"></div>
                    </div>
                    <p class="search-hint">
                        <i class="bi bi-info-circle"></i> 
                        2글자 이상 입력하면 자동으로 검색됩니다. 총 <strong>{{ all_stocks|length }}</strong>개 종목
                    </p>
                    
                    <div id="addMessage" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <!-- 통계 -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <h1 class="text-primary display-3">{{ user_stocks|length }}</h1>
                    <p class="text-muted mb-0">관심 종목</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 관심 종목 목록 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> 내 관심 종목</h5>
                </div>
                <div class="card-body">
                    {% if user_stocks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>티커</th>
                                    <th>회사명</th>
                                    <th>거래소</th>
                                    <th>섹터</th>
                                    <th>추가일</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="stocksList">
                                {% for user_stock, stock in user_stocks %}
                                <tr data-stock-id="{{ user_stock.id }}">
                                    <td><strong>{{ user_stock.ticker_symbol }}</strong></td>
                                    <td>{{ stock.company_name }}</td>
                                    <td>{{ stock.exchange or 'N/A' }}</td>
                                    <td>{{ stock.sector or 'N/A' }}</td>
                                    <td>{{ user_stock.created_at.strftime('%Y-%m-%d') if user_stock.created_at else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="removeStock({{ user_stock.id }})">
                                            <i class="bi bi-trash"></i> 삭제
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        아직 추가한 관심 종목이 없습니다. 위에서 종목을 추가해보세요!
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== 종목 검색 자동완성 =====
const searchInput = document.getElementById('stockSearchInput');
const searchResults = document.getElementById('searchResults');
let debounceTimer;
let selectedIndex = -1;
let currentResults = [];

// 디바운싱된 검색
searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    
    if (query.length < 2) {
        hideDropdown();
        return;
    }
    
    // 로딩 표시
    searchResults.innerHTML = '<div class="search-loading"><i class="bi bi-arrow-repeat"></i> 검색 중...</div>';
    searchResults.classList.add('show');
    
    debounceTimer = setTimeout(() => {
        fetchStocks(query);
    }, 300);
});

// API 호출
async function fetchStocks(query) {
    try {
        const response = await fetch(`/stocks/api/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.error) {
            searchResults.innerHTML = `<div class="no-results">${data.error}</div>`;
            return;
        }
        
        currentResults = data.stocks;
        renderDropdown(data.stocks);
    } catch (error) {
        searchResults.innerHTML = '<div class="no-results">검색 중 오류가 발생했습니다.</div>';
    }
}

// 드롭다운 렌더링
function renderDropdown(stocks) {
    selectedIndex = -1;
    
    if (stocks.length === 0) {
        searchResults.innerHTML = '<div class="no-results"><i class="bi bi-emoji-frown"></i> 검색 결과가 없습니다.</div>';
        searchResults.classList.add('show');
        return;
    }
    
    const html = stocks.map((stock, index) => `
        <div class="search-item ${stock.is_watchlist ? 'is-watchlist' : ''}" 
             data-index="${index}"
             data-ticker="${stock.ticker}">
            <div class="search-item-left">
                <span class="ticker">${stock.ticker}</span>
                <span class="name">${stock.name}</span>
            </div>
            <div class="search-item-right">
                <span class="sector">${stock.sector || 'N/A'}</span>
                ${stock.is_watchlist 
                    ? '<span class="watchlist-badge"><i class="bi bi-check-circle-fill"></i> 관심종목</span>' 
                    : '<span class="add-badge"><i class="bi bi-plus-circle"></i> 추가</span>'}
            </div>
        </div>
    `).join('');
    
    searchResults.innerHTML = html;
    searchResults.classList.add('show');
    
    // 클릭 이벤트 바인딩
    searchResults.querySelectorAll('.search-item').forEach(item => {
        item.addEventListener('click', () => selectStock(item.dataset.ticker));
    });
}

// 드롭다운 숨기기
function hideDropdown() {
    searchResults.classList.remove('show');
    selectedIndex = -1;
}

// 종목 선택 및 추가
async function selectStock(ticker) {
    const stock = currentResults.find(s => s.ticker === ticker);
    
    if (stock && stock.is_watchlist) {
        showMessage('이미 관심종목에 추가된 종목입니다.', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/stocks/api/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ticker_symbol: ticker })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(`${ticker} - ${data.stock.company_name} 추가 완료!`, 'success');
            searchInput.value = '';
            hideDropdown();
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.error || '종목 추가에 실패했습니다.', 'danger');
        }
    } catch (error) {
        showMessage('오류가 발생했습니다: ' + error.message, 'danger');
    }
}

// 키보드 네비게이션
searchInput.addEventListener('keydown', function(e) {
    const items = searchResults.querySelectorAll('.search-item');
    
    if (!searchResults.classList.contains('show') || items.length === 0) {
        return;
    }
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
            break;
            
        case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection(items);
            break;
            
        case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                selectStock(items[selectedIndex].dataset.ticker);
            }
            break;
            
        case 'Escape':
            hideDropdown();
            searchInput.blur();
            break;
    }
});

// 선택 상태 업데이트
function updateSelection(items) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
    
    // 선택된 항목이 보이도록 스크롤
    if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
    }
}

// 외부 클릭 시 드롭다운 닫기
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        hideDropdown();
    }
});

// ===== 종목 삭제 =====
async function removeStock(stockId) {
    if (!confirm('이 종목을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/stocks/api/remove/${stockId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 테이블에서 행 제거
            const row = document.querySelector(`tr[data-stock-id="${stockId}"]`);
            if (row) {
                row.remove();
            }
            
            showMessage('종목이 삭제되었습니다.', 'success');
            
            // 목록이 비었으면 리로드
            if (document.querySelectorAll('#stocksList tr').length === 0) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showMessage(data.error || '종목 삭제에 실패했습니다.', 'danger');
        }
    } catch (error) {
        showMessage('오류가 발생했습니다: ' + error.message, 'danger');
    }
}

// 메시지 표시
function showMessage(text, type) {
    const messageDiv = document.getElementById('addMessage');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'}"></i> ${text}`;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}
</script>
{% endblock %}
