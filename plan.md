# 개발 계획서 (Project Development Plan)
## 프로젝트: Stock Analysis Service
문서 버전: 0.1 (초안)  
작성일: 2025-11-20  
작성자: GitHub Copilot  
참고 문서: SRS v1.0 (`srs.md`)

---
## 1. 개요
미국 주식 관심 종목 뉴스 자동 수집/분석 및 이메일 보고 시스템을 7주 내 최소 기능(Product MVP) 수준으로 구축한다. 본 계획서는 구현 순서, 역할, 일정, 위험, 품질 및 운영 전략을 정의한다.

### 1.1 목표
- SRS에 정의된 핵심 기능 (사용자 관리, 종목 관리, 크롤링, 분석, 저장, 메일 발송, 기본 UI) 구현
- 안정적 크롤링 & 분석 파이프라인 확립 (재시도 및 로그 포함)
- ElasticSearch + SQLite 이중 저장 구조 확립
- 일일 운용이 가능한 스케줄러 기반 자동화 제공

### 1.2 범위(In-Scope)
- Flask 백엔드 + Jinja2 웹 UI (관리/일반 사용자)
- Selenium 또는 Playwright 단일 선택 후 구현 (초기 Selenium 가정)
- ChatGPT API 통한 다국어 요약 & 감성 분석
- Docker Compose 기반 단일 노드 배포 (ES 포함)
- 기본 세션 인증 (비밀번호 해시)

### 1.3 범위 제외(Out-of-Scope)
- HTTPS / JWT / 사용자 자가 가입
- 추가 뉴스 소스 (Investing.com 외)
- 캐싱(Redis), 고급 성능 최적화, 모바일 앱, 실시간 알림

### 1.4 성공 기준(KPIs)
- 크롤링 성공률 ≥ 90% (재시도 후)
- 메일 발송 성공률 ≥ 95%
- ElasticSearch 평균 조회 응답 ≤ 1초 (NFR-002)
- 크롤링 수행 시간 ≤ 30분/회 (NFR-003)

---
## 2. 산출물(Deliverables)
| 구분 | 산출물 | 설명 | 완료 기준 |
|------|--------|------|-----------|
| 코드 | Flask 앱 구조 | 디렉토리 및 초기 앱 팩토리 | 실행 및 기본 라우트 응답 |
| 데이터 | SQLite 스키마 | users, stocks 등 테이블 생성 | 마이그레이션 스크립트 성공 |
| 인덱스 | ES 인덱스 & 정책 | news_analysis + ILM 정책 | 인덱스 생성 & 문서 색인 테스트 |
| 기능 | 크롤러 모듈 | 종목별 뉴스 수집 & 중복 제거 | 지정 종목 1건 이상 색인 |
| 기능 | 분석 모듈 | ChatGPT API 호출/파싱 | JSON 구조 검증 |
| 기능 | 스케줄러 | 크롤링/메일/정리 작업 | APScheduler job 리스트 확인 |
| 운영 | Docker Compose | 로컬/서버 구동 | 단일 명령으로 서비스 기동 |
| 문서 | README | 설치/실행/환경변수 | 리뷰 승인 |
| 문서 | 테스트 보고 | 단위/통합 결과 요약 | CI 통과 로그 |

---
## 3. 일정 및 마일스톤 (총 7주)
| 주차 | 마일스톤 | 세부 작업 | 완료 조건 |
|------|-----------|-----------|-----------|
| 1 | 기반 구조 | 디렉토리, 앱 초기화, 환경설정(.env), DB 스키마, Docker 기본 | 로컬 Flask + ES 컨테이너 기동 |
| 2 | 데이터 & 인덱스 | SQLAlchemy 모델, ES 인덱스 생성, 저장 어댑터 | 모델 CRUD & ES 색인 테스트 |
| 3 | 크롤러 MVP | Selenium 설정, Investing.com 파싱, 중복 로직 | 1개 티커 뉴스 ≥3건 수집 |
| 4 | 분석 & 저장 파이프라인 | ChatGPT 프롬프트, 다국어 요약, 감성 점수, 파이프라인 통합 | 색인 문서에 summary/sentiment 포함 |
| 5 | 웹 UI / API | 인증, 종목 관리, 뉴스 조회, 통계 기본, 관리자 상태 | 핵심 API / 페이지 렌더링 |
| 6 | 메일 & 스케줄러 | HTML 템플릿, SMTP, APScheduler 잡, 재시도/로그 | 사용자별 테스트 메일 발송 성공 |
| 7 | 테스트/배포 | 단위/통합 테스트, 성능 점검, 서버 배포, 문서 업데이트 | 서버 실환경 가동 & 기본 모니터링 |

선행 관계: 1→2→3→4 병행 5 시작 가능(크롤러 일부 데이터 필요), 6은 4/5 완료 후, 7은 모든 기능 통합 후.

---
## 4. 작업 분해 구조(WBS)
번호 체계: P-Phase.M-Module.T-Task

### 4.1 Phase 1 (기반)
- P1.M1.T1: Flask 앱 팩토리 (`app/__init__.py`)
- P1.M1.T2: 환경 변수 로딩 유틸 (`utils/config.py`)
- P1.M2.T3: requirements.txt 초기화
- P1.M3.T4: Dockerfile / docker-compose.yml 초안
- P1.M4.T5: 초기 로그 설정 (logging 기본 핸들러)

### 4.2 Phase 2 (데이터)
- P2.M1.T1: SQLAlchemy 모델 (users/user_settings/stock_master/user_stocks/email_logs/crawl_logs)
- P2.M1.T2: DB 세션 관리 유틸
- P2.M2.T3: ES 클라이언트 초기화
- P2.M2.T4: news_analysis 인덱스 및 ILM policy 생성 스크립트
- P2.M3.T5: 저장 서비스 (뉴스 색인 함수)

### 4.3 Phase 3 (크롤링)
- P3.M1.T1: Selenium 드라이버 초기화 (Headless 옵션)
- P3.M1.T2: 티커→검색 쿼리 생성 유틸
- P3.M1.T3: 뉴스 목록 추출 & 시간 필터
- P3.M1.T4: 중복 검사 (URL 키)
- P3.M1.T5: 에러/재시도 로직 (최대 3회)

### 4.4 Phase 4 (분석)
- P4.M1.T1: ChatGPT 요청 포맷 정의 (FR-020 활용)
- P4.M1.T2: 응답 JSON 파싱 및 검증
- P4.M1.T3: 감성 점수 정상 범위(-10~10) 확인
- P4.M1.T4: 파이프라인 결합 (크롤링→분석→저장)

### 4.5 Phase 5 (API & UI)
- P5.M1.T1: 인증 라우트 (/api/auth/*)
- P5.M1.T2: 사용자 설정/종목 API
- P5.M1.T3: 뉴스 조회/히스토리/통계 API
- P5.M1.T4: 관리자 API (시스템 상태)
- P5.M2.T5: Jinja 템플릿: 대시보드/종목/뉴스/통계/설정/관리자

### 4.6 Phase 6 (메일 & 스케줄)
- P6.M1.T1: HTML 메일 템플릿 구현
- P6.M1.T2: 이메일 전송 함수 (재시도 포함)
- P6.M2.T3: 스케줄러 잡 등록 (크롤링/메일/정리)
- P6.M2.T4: 통계 집계 유틸 (호재/악재 비율)

### 4.7 Phase 7 (테스트/배포)
- P7.M1.T1: 단위 테스트 (모델/크롤러/분석)
- P7.M1.T2: 통합 테스트 (전체 파이프라인)
- P7.M2.T3: 로드 샘플(소규모 성능 테스트)
- P7.M3.T4: 서버 배포 스크립트 (prod .env)
- P7.M3.T5: 최종 문서 & 운영 핸드북

---
## 5. 요구사항 추적 매트릭스 (요약)
| FR/NFR | 매핑 모듈/작업 | 검증 방식 |
|--------|----------------|-----------|
| FR-001~005 | 사용자/설정 API (P5.M1.T1~T2) | API 테스트 & DB 확인 |
| FR-006~010 | 종목 관리 & stock_master (P2.M1.T1, P5.M1.T2) | CRUD 테스트 |
| FR-011~017 | 크롤러 (P3.*) | 크롤링 로그 & 중복 테스트 |
| FR-018~020 | 분석 엔진 (P4.*) | 응답 JSON 구조 검증 |
| FR-021~024 | SQLite 모델 (P2.M1.T1) | 마이그레이션 + 단위 테스트 |
| FR-025~028 | ES 인덱스 & 정책 (P2.M2.T4) | 문서 색인 & 삭제 시뮬레이션 |
| FR-029~038 | 메일 & 스케줄러 (P6.*) | 스케줄 실행 로그 |
| FR-039~060 | UI/관리자 (P5.M2.T5) | 페이지 렌더 & 기능 테스트 |
| NFR-001~004 | 성능 테스트 (P7.M2.T3) | 측정 리포트 |
| NFR-011~015 | 보안(해시/세션/XSS) | 코드 리뷰 & 침투 테스트 기초 |
| NFR-019~022 | 코드 스타일/로깅 | 린트 결과 & 로그 파일 |

---
## 6. 기술 구현 전략
### 6.1 Flask 구조
- 앱 팩토리 패턴 + Blueprint: auth, user, stocks, news, admin
- 서비스 레이어 분리: `services/` (crawler, analyzer, email_sender, scheduler)

### 6.2 크롤러 선택
- 초기: Selenium (풍부한 사례, 안정성)
- 드라이버: Chrome headless (추후 Playwright 전환 가능성 열어둠)
- 타임아웃 & 암묵적 대기 설정 (예: 10s)

### 6.3 분석 엔진
- ChatGPT 요청 배치 처리 최소화 (뉴스 건수 많을 경우 속도 고려)
- 실패 시 재시도 + Fallback: 간단한 규칙 기반 요약 (Title 기반 1문장)

### 6.4 저장 로직
- 뉴스 단위 트랜잭션: 크롤링 후 메모리 목록 → 분석 후 ES Bulk 색인
- SQLite는 사용자/설정/로그만. 뉴스 본문은 ES에만 저장.

### 6.5 스케줄러
- APScheduler BackgroundScheduler + jobstore (기본 메모리)
- Job 목록: crawl_job(3h), email_job(1h check), cleanup_job(daily)

---
## 7. 테스트 전략
### 7.1 단위 테스트
- 모델 CRUD (pytest + sqlite memory)
- 크롤러 파싱 함수 (HTML fixture)
- 분석 응답 파서 (Mock OpenAI 응답)

### 7.2 통합 테스트
- End-to-end: 티커 → 크롤링 → 분석 → ES 색인 → API 응답

### 7.3 성능 테스트(샘플)
- 10개 뉴스 분석 평균 소요 시간 측정
- ES 검색 latency 측정 (p95 < 1s 목표)

### 7.4 품질 게이트
- 린트: flake8 / black (PEP8 준수)
- 타입(옵션): mypy (핵심 서비스 레이어)

---
## 8. 보안 & 운영 전략
- 비밀번호: bcrypt cost=12
- 세션 보호: SECRET_KEY .env 관리
- 환경변수 로딩: python-dotenv
- 로그 회전: 주 단위(추가 개선 여지)
- API 키: .env + .gitignore

---
## 9. 배포 전략
### 9.1 Docker
- 다중 서비스: flask-app, elasticsearch
- Gunicorn 실행 (예: workers=2, threads=4, timeout=120)

### 9.2 배포 단계
1. 이미지 빌드 & 태그
2. 서버 .env 배치
3. docker-compose pull/build/up
4. 헬스체크: /api/auth/session, ES 상태, 크롤링 로그

### 9.3 롤백
- 이전 태그 이미지 유지 → docker-compose 다운 후 이전 버전 up

---
## 10. 로깅 & 모니터링
- 로그 파일 분리: app.log, crawler.log, email.log, error.log
- 포맷: 시간 | 레벨 | 모듈 | 메시지
- 모니터링 지표(수동): 크롤링 성공 건수, 메일 발송 실패율

---
## 11. 위험(Risk) 및 대응
| 유형 | 리스크 | 영향 | 확률 | 대응/완화 |
|------|--------|------|------|-----------|
| 기술 | Investing DOM 변경 | 크롤링 실패 | 중 | 파싱 추상화 & Selector 예비안 |
| 기술 | OpenAI 속도/비용 | 분석 지연/비용 증가 | 중 | 캐싱·요약 길이 제한 |
| 운영 | Gmail 한도 초과 | 메일 중단 | 저 | 사용자 수 제한 + 발송 모니터링 |
| 일정 | 크롤러 지연 | 후속 단계 밀림 | 중 | 초기 단순 버전 → 점진 개선 |
| 품질 | ES 색인 오류 누적 | 통계 부정확 | 저 | 색인 검증 & 에러 로그 경고 |

---
## 12. 역할 및 리소스 (가정)
| 역할 | 담당 | 주요 책임 |
|------|------|-----------|
| 백엔드 개발 | Dev A | Flask, 모델, API |
| 크롤링/분석 | Dev B | Selenium, ChatGPT 연동 |
| 프론트/UI | Dev C | Jinja 템플릿, 차트 |
| 테스트/품질 | Dev D | 테스트 코드, CI |
| 운영/배포 | Dev E | Docker, 배포, 로그 |
(소규모 팀이므로 실제론 2~3명이 복수 역할 수행 가능)

---
## 13. 커뮤니케이션 & 협업
- 일일 스탠드업 (15분): 진행/이슈/차일드 태스크
- 주간 리뷰: 마일스톤 점검
- 이슈 트래킹: GitHub Issues (태그: backend, crawler, ui, ops, test)
- 코드 리뷰: 최소 1명 승인 후 main 병합

---
## 14. 변경 관리
- 요구 변경 발생 시 Issue → 영향 분석(범위/일정) → 승인 → 반영
- SRS 변경 시 추적 매트릭스 업데이트

---
## 15. 환경 변수 관리
- `.env.example` 제공 → 민감 정보 제외
- 운영 환경: 별도 .env (권한 제한)

---
## 16. 성능 최적화(초기 가이드)
- 크롤링 병렬성 제한: 순차 또는 소규모 배치 (티커 ≤ 10 가정)
- ChatGPT 호출: 필요시 rate limit 대기
- ES 쿼리: 필요한 필드만 반환 (source filtering)

---
## 17. 종료 & 인수 기준
- 모든 FR 주요 기능 동작 (크롤링→분석→저장→메일)
- 관리자 페이지로 상태 확인 가능
- 테스트 통과율 ≥ 85% (단위 + 통합)
- 문서(README, plan, SRS) 최신화

---
## 18. 향후 확장 고려 요약
- 다중 뉴스 소스 / Redis 캐시 / JWT / HTTPS / 실시간 알림 / 추천 기능 / 분석 고도화

---
## 19. 문서 개정 이력
| 버전 | 날짜 | 작성자 | 변경 내용 |
|-------|------|--------|-----------|
| 0.1 | 2025-11-20 | Copilot | 초안 작성 |

(끝)
